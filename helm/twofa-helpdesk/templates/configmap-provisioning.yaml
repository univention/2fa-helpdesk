# SPDX-License-Identifier: AGPL-3.0-only
# SPDX-FileCopyrightText: 2024 Univention GmbH

{{- if .Values.provisioning.enabled }}
---
apiVersion: "v1"
kind: ConfigMap
metadata:
  name: {{ printf "%s-provisioning-init" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
    {{- if .Values.provisioning.extraLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.provisioning.extraLabels "context" . ) | nindent 4 }}
    {{- end }}
  {{- if .Values.provisioning.extraAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.provisioning.extraAnnotations "context" . ) | nindent 4 }}
  {{- end }}

data:
  KEYCLOAK_URL: {{ tpl .Values.twofaHelpdeskBackend.config.keycloak_url . | quote }}
---
kind: "ConfigMap"
apiVersion: "v1"
metadata:
  name: {{ printf "%s-provisioning-env" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
    {{- if .Values.provisioning.additionalLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.additionalLabels.additionalLabels "context" . ) | nindent 4 }}
    {{- end }}
  {{- if .Values.provisioning.additionalAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.provisioning.additionalAnnotations "context" . ) | nindent 4 }}
  {{- end }}
data:
  DEBUG: {{ .Values.provisioning.config.debug.enabled | quote }}
  DOMAIN: {{ .Values.global.domain | quote }}
  KEYCLOAK_USERNAME: {{ tpl .Values.twofaHelpdeskBackend.config.keycloak_admin_user . | quote }}
  KEYCLOAK_HOST: {{ tpl .Values.twofaHelpdeskBackend.config.oidc_host . | quote }}
  KEYCLOAK_REALM: {{ tpl .Values.twofaHelpdeskBackend.config.oidc_realm . | quote }}
  KEYCLOAK_URL: {{ tpl .Values.twofaHelpdeskBackend.config.keycloak_url . | quote }}
  UNIVENTION_KEYCLOAK_BOOTSTRAP_TEMP_DIR: "/tmp"
  UNIVENTION_KEYCLOAK_BOOTSTRAP_DEBUG_PAUSE_BEFORE_SCRIPT_START: {{ .Values.provisioning.config.debug.pauseBeforeScriptStart  | quote }}
  KEYCLOAK_APP_BASE_URL: {{ tpl .Values.twofaHelpdeskBackend.config.app_path . | quote }}
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ printf "%s-provisioning-script" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
    {{- if .Values.provisioning.additionalLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.additionalLabels.additionalLabels "context" . ) | nindent 4 }}
    {{- end }}
  {{- if .Values.provisioning.additionalAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.provisioning.additionalAnnotations "context" . ) | nindent 4 }}
  {{- end }}
data:
  run.py: |
    print("Lol")
{{- end }}